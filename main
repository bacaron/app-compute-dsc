#!/bin/bash
#PBS -k o
#PBS -l nodes=1:ppn=4,walltime=00:30:00

export PYTHONPATH=/N/u/brlife/git/nibabel:$PYTHONPATH

echo "setting miniconda path..."
unset PYTHONPATH
export PATH=/N/u/gberto/Karst/miniconda2/bin:$PATH 

echo "Check the inputs subject id"
tck_id=`jq -r '._inputs[0].meta.subject' config.json`
wmc_est_id=`jq -r '._inputs[1].meta.subject' config.json`
wmc_true_id=`jq -r '._inputs[2].meta.subject' config.json`
run=`jq -r '.run' config.json`
if [ $wmc_est_id == $tck_id -a $wmc_true_id == $tck_id ]; then
	echo "Inputs subject IDs correctly inserted"
else
	echo "Inputs subject IDs incorrectly inserted. Check them again."
	exit 1
fi

seg_est=`jq -r '.seg_est' config.json`
seg_true=`jq -r '.seg_true' config.json`
if [ $seg_est == $seg_true ]; then
	echo "Error: estimated segmentation and ground truth segmentation are the same. DSC will be 1."
	exit 1
fi

if [ $seg_est == *.mat -a $seg_true == *.mat ]; then
	echo "Estimated and ground truth tracts given as wmc"
	./run_wmc-wmc.sh
elif  [ $seg_est == masks -a $seg_true == *.mat ]; then
	echo "Estimated tracts given as masks and ground truth tracts given as wmc"
	./run_mask-wmc.sh
elif  [ $seg_est == *.mat -a $seg_true == *.trk ]; then
	echo "Estimated tracts given as wmc and round truth tract given as .trk"
	./run_wmc-trk.sh
fi

mkdir csv
cp sub-${tck_id}_results.csv csv/output_FiberStats.csv

if [ -z "$(ls -A -- "csv")" ]; then    
	echo "Computation failed."; 
	exit 1;
else    
	echo "Computation done." 
fi
