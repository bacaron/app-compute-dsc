#!/bin/bash
#PBS -k o
#PBS -l nodes=1:ppn=4,walltime=00:30:00

export PYTHONPATH=/N/u/brlife/git/nibabel:$PYTHONPATH

echo "setting miniconda path..."
unset PYTHONPATH
export PATH=/N/u/gberto/Karst/miniconda2/bin:$PATH 

subjID=`jq -r '._inputs[0].meta.subject' config.json`
seg_est=`jq -r '.seg_est' config.json`
seg_true=`jq -r '.seg_true' config.json`
if [ $seg_est == $seg_true ]; then
	echo "Error: estimated segmentation and ground truth segmentation are the same. DSC will be 1."
	exit 1
fi


if [[ $seg_true == masks ]]; then

	if [ `jq -r '._inputs[1].meta.subject' config.json` == $subjID ]; then
		echo "Inputs subject IDs correctly inserted"
	else
		echo "Inputs subject IDs incorrectly inserted. Check them again."
		exit 1
	fi
	echo "Estimated and ground truth tracts given as masks"
	echo "Computing voxel measures"
	python evaluation_mask-mask.py -sub $subjID -dir_est $seg_est -dir_true $seg_true

else 
	
	echo "Check the inputs subject id"
	wmc_est_id=`jq -r '._inputs[1].meta.subject' config.json`
	wmc_true_id=`jq -r '._inputs[2].meta.subject' config.json`
	run=`jq -r '.run' config.json`
	if [ $wmc_est_id == $subjID -a $wmc_true_id == $subjID ]; then
		echo "Inputs subject IDs correctly inserted"
	else
		echo "Inputs subject IDs incorrectly inserted. Check them again."
		exit 1
	fi

	if [[ $seg_est == *.mat ]]; then
		if [[ $seg_true == *.mat ]]; then
			echo "Estimated and ground truth tracts given as wmc"
			./run_wmc-wmc.sh
		elif [[ $seg_true == *.trk ]]; then
			echo "Estimated tracts given as wmc and ground truth tract given as .trk"
			./run_wmc-trk.sh
		fi
	elif  [[ $seg_est == masks ]]; then
		echo "Estimated tracts given as masks and ground truth tracts given as wmc"
		./run_mask-wmc.sh
	fi

fi


mkdir csv
cp sub-${subjID}_results.csv csv/output_FiberStats.csv

if [ -z "$(ls -A -- "csv")" ]; then    
	echo "Computation failed."; 
	exit 1;
else    
	echo "Computation done." 
fi
